# 02.8 IoT Gateway – Raspberry Pi + Node-RED

## 1. Descrizione Generale
L’**IoT Gateway** è un **Raspberry Pi 4** configurato come nodo di edge computing per la Learning Factory 4.0. Esegue un’istanza di **Node-RED**, che funge da:
- interfaccia HMI locale,
- bridge tra PLC (OPC-UA) e TXT Controller (MQTT),
- gestore della calibrazione delle stazioni,
- archivio dati delle configurazioni,
- punto di diagnosi e monitoraggio.

In un sistema Industry 4.0, questo componente rappresenta il livello **Edge**, collocandosi tra il controllo real-time del PLC e la supervisione cloud.

---

## 2. Funzione nel Processo Produttivo
L’IoT Gateway svolge cinque ruoli fondamentali:
1. **Traduzione protocolli**: OPC-UA (PLC) → MQTT (TXT).
2. **Sincronizzazione**: fornisce al PLC i dati di calibrazione e i parametri.
3. **HMI (Human Machine Interface)**: visualizza stati, errori e posizioni.
4. **Calibrazione** delle stazioni VGR, HBW, MPO, SLD.
5. **Persistere configurazioni** in `ConfigData.csv`.

Senza il Gateway, la fabbrica perderebbe l’integrazione edge-cloud.

---

## 3. Architettura del Sistema
### 3.1 Componenti Hardware
- Raspberry Pi 4
- Alimentazione tramite TP-Link Router
- Scheda SD con sistema Linux preconfigurato

### 3.2 Software Principale
- Node.js
- Node-RED Runtime
- Node-RED Dashboard
- Servizi MQTT client
- Servizi OPC-UA client

### 3.3 Struttura Node-RED
Node-RED gestisce:
- HMI
- Calibrazione
- Comunicazione MQTT/OPC-UA
- Salvataggio e caricamento configurazioni

---

## 4. Flussi Node-RED Principali
### 4.1 **HMI – Main Dashboard**
Mostra:
- Stato PLC
- Stato VGR, HBW, MPO, SLD
- Errori
- Comandi manuali

### 4.2 **Calibration**
Sottosezioni:
- VGR Positions
- HBW Positions
- MPO Positions
- SLD Positions
- SSC Camera Calibration

### 4.3 **File Handling**
Gestisce:
- scrittura `ConfigData.csv`
- caricamento all’avvio
- backup periodici

---

## 5. File di Configurazione – `ConfigData.csv`
Situato in:
```
/home/pi/.node-red/pub/CSV/ConfigData.csv
```
Contiene valori critici:
- posizioni VGR X/Y/Z
- livelli HBW (coordinate verticali)
- posizioni MPO piano
- calibrazioni SLD
- parametri SSC

Il PLC richiede questo file ad ogni avvio.

---

## 6. Diagramma Funzionale
```mermaid
flowchart LR
  PLC["PLC S7-1500 (OPC-UA)"]
  GATEWAY["IoT Gateway – Node-RED"]
  TXT["TXT Controller 4.0 (MQTT)"]
  CLOUD["Fischertechnik Cloud"]

  PLC --> GATEWAY
  GATEWAY --> TXT
  TXT --> CLOUD
  CLOUD --> TXT
```

---

## 7. Ciclo Operativo Dettagliato
### 7.1 Avvio
1. Raspberry si accende.
2. Node-RED avvia flussi.
3. Carica `ConfigData.csv`.
4. Stabilisce connessioni OPC-UA + MQTT.

### 7.2 Durante la Produzione
- Riceve comandi dal PLC.
- Invia segnali MQTT al TXT.
- Aggiorna HMI.
- Registra nuovi valori di calibrazione.

### 7.3 Fine Produzione
- Aggiorna storico file `ConfigData.csv`.
- Mantiene stato HMI in standby.

---

## 8. Errori Comuni e Diagnostica
### Errori di Comunicazione
- Connessione OPC-UA persa
- MQTT offline
- Timeout TXT

### Errori HMI
- Dashboard non raggiungibile
- Pulsanti non funzionanti (flow rotto)

### Diagnostica
- Node-RED Log
- LED Raspberry
- Console SSH
- HMI → pagina diagnostica

---

## 9. Sicurezza e Networking
### Indirizzi Standard
- Gateway: `192.168.0.5`
- Router: `192.168.0.252`
- TXT: `192.168.0.10`

### Porte Principali
| Protocollo | Porta | Funzione |
|------------|--------|----------|
| HTTP | 1880 | Node-RED Dashboard |
| MQTT | 1883 | Messaggi TXT ↔ Gateway |
| OPC-UA | 4840 | PLC ↔ Gateway |

---

## 10. Ruolo nel Contesto Industry 4.0
L’IoT Gateway è il cuore del livello Edge Computing, svolgendo:
- integrazione OT (PLC) ↔ IT (Cloud),
- pre-elaborazione dati,
- gestione configurazioni,
- supporto alla manutenzione predittiva,
- bridging protocollare.

Costituisce la base della trasformazione digitale della microfactory.

---

## 11. Collegamenti con Altri Moduli
- [[02.7_PLC_Siemens_S7-1500.md]]
- [[02.9_TXT_Controller_4.0.md]]

